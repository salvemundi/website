services:
  # Base Infrastructure
  db:
    ports:
      - "127.0.0.1:5432:5432"

  directus:
    ports:
      - "127.0.0.1:8055:8055"

  # Secure Outbound Proxy
  secure-proxy:
    image: ubuntu/squid
    volumes:
      - ./infra/proxy/squid.conf:/etc/squid/squid.conf
    ports:
      - "3128:3128"
    networks:
      public-ingress:
        aliases:
          - secure-proxy

  # Identity Service
  identity:
    ports:
      - "127.0.0.1:3002:3002"
    environment:
      - HTTP_PROXY=http://secure-proxy:3128
      - HTTPS_PROXY=http://secure-proxy:3128
      - NO_PROXY=localhost,127.0.0.1,db,directus,finance,email,notifications,identity
      - DIRECTUS_URL=https://admin.salvemundi.nl
    networks:
      - service-mesh
      - data-plane
      - public-ingress

  # Finance Service
  finance:
    dns:
      - 8.8.8.8
      - 1.1.1.1
    ports:
      - "127.0.0.1:3001:3001"
    environment:
      - HTTP_PROXY=http://secure-proxy:3128
      - HTTPS_PROXY=http://secure-proxy:3128
      - NO_PROXY=localhost,127.0.0.1,db,directus,finance,email,notifications,identity
      - DIRECTUS_URL=https://admin.salvemundi.nl
    networks:
      - service-mesh
      - data-plane
      - public-ingress

  # Email Service
  email:
    ports:
      - "127.0.0.1:3003:3003"
    environment:
      - HTTP_PROXY=http://secure-proxy:3128
      - HTTPS_PROXY=http://secure-proxy:3128
      - NO_PROXY=localhost,127.0.0.1,db,directus,finance,email,notifications,identity
      - DIRECTUS_URL=https://admin.salvemundi.nl
    networks:
      - service-mesh
      - public-ingress

  # Notifications Service
  notifications:
    ports:
      - "127.0.0.1:3004:3004"
    environment:
      - HTTP_PROXY=http://secure-proxy:3128
      - HTTPS_PROXY=http://secure-proxy:3128
      - NO_PROXY=localhost,127.0.0.1,db,directus,finance,email,notifications,identity
      - DIRECTUS_URL=https://admin.salvemundi.nl
    networks:
      - service-mesh
      - public-ingress

  # Web/Frontend
  web:
    environment:
      - FINANCE_SERVICE_URL=http://finance:3001
      - IDENTITY_SERVICE_URL=http://identity:3002
      - EMAIL_SERVICE_URL=http://email:3003
      - NOTIFICATION_SERVICE_URL=http://notifications:3004
      - INTERNAL_DIRECTUS_URL=https://admin.salvemundi.nl
    networks:
      - service-mesh
      - public-ingress
