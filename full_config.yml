name: website
services:
  db:
    environment:
      POSTGRES_DB: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_USER: postgres
    healthcheck:
      test:
        - CMD-SHELL
        - pg_isready -U postgres -d postgres
      timeout: 5s
      interval: 10s
      retries: 5
    image: postgres:15
    logging:
      driver: json-file
      options:
        max-file: "3"
        max-size: 10m
    networks:
      data-plane: null
    ports:
      - mode: ingress
        target: 5432
        published: "5432"
        protocol: tcp
    restart: unless-stopped
    volumes:
      - type: volume
        source: postgres_data
        target: /var/lib/postgresql/data
        volume: {}
  directus:
    depends_on:
      db:
        condition: service_healthy
        required: true
    environment:
      ADMIN_EMAIL: admin@example.com
      ADMIN_PASSWORD: admin
      DB_CLIENT: pg
      DB_DATABASE: postgres
      DB_HOST: db
      DB_PASSWORD: postgres
      DB_PORT: "5432"
      DB_USER: postgres
      KEY: directus-key-dev
      PUBLIC_URL: https://admin.salvemundi.nl
      SECRET: directus-secret-dev
    image: directus/directus:10.10
    logging:
      driver: json-file
      options:
        max-file: "3"
        max-size: 10m
    networks:
      data-plane: null
      public-ingress: null
      service-mesh: null
    ports:
      - mode: ingress
        target: 8055
        published: "8055"
        protocol: tcp
    restart: unless-stopped
    volumes:
      - type: volume
        source: directus_uploads
        target: /directus/uploads
        volume: {}
  email:
    build:
      context: C:\Users\Roan\Documents\website\services\email
      dockerfile: Dockerfile
    environment:
      DIRECTUS_ADMIN_TOKEN: tnDrdaB_OkA5u3GrLTUt_CJqLzTUy_TN
      DIRECTUS_URL: https://admin.salvemundi.nl
      HTTP_PROXY: http://secure-proxy:3128
      HTTPS_PROXY: http://secure-proxy:3128
      NO_PROXY: localhost,127.0.0.1,db,directus,finance,email,notifications,identity
      SERVICE_SECRET: dev-service-secret-123
    logging:
      driver: json-file
      options:
        max-file: "3"
        max-size: 10m
    networks:
      service-mesh: null
    ports:
      - mode: ingress
        target: 3003
        published: "3003"
        protocol: tcp
    restart: unless-stopped
  finance:
    build:
      context: C:\Users\Roan\Documents\website\services\finance
      dockerfile: Dockerfile
    environment:
      DIRECTUS_ADMIN_TOKEN: tnDrdaB_OkA5u3GrLTUt_CJqLzTUy_TN
      DIRECTUS_URL: https://admin.salvemundi.nl
      HTTP_PROXY: http://secure-proxy:3128
      HTTPS_PROXY: http://secure-proxy:3128
      MOLLIE_API_KEY: test_mollie_key
      NO_PROXY: localhost,127.0.0.1,db,directus,finance,email,notifications,identity
      SERVICE_SECRET: dev-service-secret-123
    logging:
      driver: json-file
      options:
        max-file: "3"
        max-size: 10m
    networks:
      data-plane: null
      public-ingress: null
      service-mesh: null
    ports:
      - mode: ingress
        target: 3001
        published: "3001"
        protocol: tcp
    restart: unless-stopped
  identity:
    build:
      context: C:\Users\Roan\Documents\website\services\identity
      dockerfile: Dockerfile
    environment:
      DIRECTUS_ADMIN_TOKEN: tnDrdaB_OkA5u3GrLTUt_CJqLzTUy_TN
      DIRECTUS_URL: https://admin.salvemundi.nl
      HTTP_PROXY: http://secure-proxy:3128
      HTTPS_PROXY: http://secure-proxy:3128
      MS_GRAPH_CLIENT_ID: dummy-client-id
      MS_GRAPH_CLIENT_SECRET: dummy-client-secret
      MS_GRAPH_DOMAIN: dummy-domain.com
      MS_GRAPH_TENANT_ID: dummy-tenant-id
      NO_PROXY: localhost,127.0.0.1,db,directus,finance,email,notifications,identity
      SERVICE_SECRET: dev-service-secret-123
    logging:
      driver: json-file
      options:
        max-file: "3"
        max-size: 10m
    networks:
      data-plane: null
      public-ingress: null
      service-mesh: null
    ports:
      - mode: ingress
        target: 3002
        published: "3002"
        protocol: tcp
    restart: unless-stopped
  notifications:
    build:
      context: C:\Users\Roan\Documents\website\services\notifications
      dockerfile: Dockerfile
    environment:
      DIRECTUS_NOTIFICATION_KEY: tnDrdaB_OkA5u3GrLTUt_CJqLzTUy_TN
      DIRECTUS_URL: https://admin.salvemundi.nl
      HTTP_PROXY: http://secure-proxy:3128
      HTTPS_PROXY: http://secure-proxy:3128
      NO_PROXY: localhost,127.0.0.1,db,directus,finance,email,notifications,identity
      SERVICE_SECRET: dev-service-secret-123
      VAPID_PRIVATE_KEY: dummy-vapid-private-key
      VAPID_PUBLIC_KEY: dummy-vapid-public-key
    logging:
      driver: json-file
      options:
        max-file: "3"
        max-size: 10m
    networks:
      service-mesh: null
    ports:
      - mode: ingress
        target: 3004
        published: "3004"
        protocol: tcp
    restart: unless-stopped
  secure-proxy:
    image: ubuntu/squid
    networks:
      public-ingress: null
      service-mesh: null
    ports:
      - mode: ingress
        target: 3128
        published: "3128"
        protocol: tcp
    volumes:
      - type: bind
        source: C:\Users\Roan\Documents\website\infra\proxy\squid.conf
        target: /etc/squid/squid.conf
        bind: {}
  web:
    build:
      context: C:\Users\Roan\Documents\website\apps\web
      dockerfile: Dockerfile
    environment:
      DIRECTUS_ADMIN_TOKEN: tnDrdaB_OkA5u3GrLTUt_CJqLzTUy_TN
      NEXT_PUBLIC_DIRECTUS_URL: https://admin.salvemundi.nl
      SERVICE_SECRET: dev-service-secret-123
    logging:
      driver: json-file
      options:
        max-file: "3"
        max-size: 10m
    networks:
      public-ingress: null
      service-mesh: null
    restart: unless-stopped
networks:
  data-plane:
    name: website_data-plane
    internal: true
  public-ingress:
    name: website_public-ingress
    driver: bridge
  service-mesh:
    name: website_service-mesh
    internal: true
volumes:
  directus_uploads:
    name: website_directus_uploads
  postgres_data:
    name: website_postgres_data
