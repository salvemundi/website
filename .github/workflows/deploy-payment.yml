name: Deploy Payment API

on:
  push:
    branches:
      - 'Development'
      - 'Acceptance'
      - 'main'
    paths:
      - 'payment-api/**'
      - '.github/workflows/deploy-payment.yml'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Login to GitHub Container Registry (Build)
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set Environment Variables
        id: vars
        run: |
          if [[ "${{ github.ref_name }}" == "Development" ]]; then
            echo "ENV_TAG=dev" >> $GITHUB_ENV
            echo "IS_DEV=true" >> $GITHUB_ENV
          else
            echo "ENV_TAG=latest" >> $GITHUB_ENV
            echo "IS_DEV=false" >> $GITHUB_ENV
          fi

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v4
        with:
          context: ./payment-api
          push: true
          tags: ghcr.io/salvemundi/payment-api:${{ env.ENV_TAG }}

      - name: Deploy to Server
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # 1. Ga naar de juiste map
            cd /opt/payment-api || exit 1

            # 2. Log in bij Docker
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # 3. Maak het .env bestand aan (NU MET TAG!)
            echo "# Auto-generated by GitHub Actions" > .env.payment
            echo "PORT=3002" >> .env.payment
            echo "TAG=${{ env.ENV_TAG }}" >> .env.payment

            if [ "${{ env.IS_DEV }}" = "true" ]; then
              echo "Deploying DEV Configuration..."
              echo "MOLLIE_API_KEY=${{ secrets.DEV_MOLLIE_API_KEY }}" >> .env.payment
              echo "MOLLIE_WEBHOOK_URL=${{ secrets.DEV_MOLLIE_WEBHOOK_URL }}" >> .env.payment
              echo "DIRECTUS_URL=${{ secrets.DEV_DIRECTUS_URL }}" >> .env.payment
              echo "DIRECTUS_API_TOKEN=${{ secrets.DEV_DIRECTUS_API_TOKEN }}" >> .env.payment
            else
              echo "Deploying PROD Configuration..."
              echo "MOLLIE_API_KEY=${{ secrets.PROD_MOLLIE_API_KEY }}" >> .env.payment
              echo "MOLLIE_WEBHOOK_URL=${{ secrets.PROD_MOLLIE_WEBHOOK_URL }}" >> .env.payment
              echo "DIRECTUS_URL=${{ secrets.PROD_DIRECTUS_URL }}" >> .env.payment
              echo "DIRECTUS_API_TOKEN=${{ secrets.PROD_DIRECTUS_API_TOKEN }}" >> .env.payment
            fi

            # 4. Pull en Herstart (Met env file zodat warnings weg zijn)
            # We gebruiken --env-file ook bij pull zodat hij ${TAG} snapt
            docker compose --env-file .env.payment pull payment-api
            docker compose --env-file .env.payment up -d --force-recreate payment-api