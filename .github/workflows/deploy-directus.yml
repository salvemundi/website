name: Deploy Directus

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: salvemundi/directus
  DEPLOY_PATH: /opt/directus

concurrency:
  group: deploy-directus-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Map Secrets to Environment
        id: selection
        run: |
          TARGET_BRANCH="${{ github.event.workflow_run.head_branch || github.ref_name }}"
          if [[ "$TARGET_BRANCH" == "main" ]]; then
            echo "TAG=latest" >> $GITHUB_ENV
          else
            echo "TAG=dev" >> $GITHUB_ENV
          fi
          echo "DEPLOY_PATH=/opt/directus" >> $GITHUB_ENV

          # Build CORS_ORIGIN with all required origins, filtering out empties
          CORS_LIST="https://admin.salvemundi.nl,https://preprod.salvemundi.nl,https://salvemundi.nl,https://dev.salvemundi.nl"
          if [ -n "${{ secrets.PROD_CORS_ORIGIN }}" ]; then
            CORS_LIST="${{ secrets.PROD_CORS_ORIGIN }},$CORS_LIST"
          fi
          if [ -n "${{ secrets.DEV_CORS_ORIGIN }}" ]; then
            CORS_LIST="${{ secrets.DEV_CORS_ORIGIN }},$CORS_LIST"
          fi
          # Remove any duplicate entries
          CORS_LIST=$(echo "$CORS_LIST" | tr ',' '\n' | sort -u | tr '\n' ',' | sed 's/,$//')
          printf "CORS_ORIGIN=%s\n" "$CORS_LIST" >> $GITHUB_ENV

          # Global Secrets (Same for both)
          echo "DIRECTUS_KEY=${{ secrets.DIRECTUS_KEY }}" >> $GITHUB_ENV
          echo "DIRECTUS_SECRET=${{ secrets.DIRECTUS_SECRET }}" >> $GITHUB_ENV
          echo "ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}" >> $GITHUB_ENV
          echo "ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}" >> $GITHUB_ENV
          echo "PUBLIC_URL=${{ secrets.DIRECTUS_URL }}" >> $GITHUB_ENV
          
          # Database
          echo "POSTGRES_DB=${{ secrets.DB_DATABASE }}" >> $GITHUB_ENV
          echo "POSTGRES_USER=${{ secrets.DB_USER }}" >> $GITHUB_ENV
          echo "POSTGRES_PASSWORD=${{ secrets.DB_PASSWORD }}" >> $GITHUB_ENV
          
          # Auth (Microsoft Entra ID - Global)
          echo "AUTH_MICROSOFT_CLIENT_ID=${{ secrets.AUTH_MICROSOFT_CLIENT_ID }}" >> $GITHUB_ENV
          echo "AUTH_MICROSOFT_CLIENT_SECRET=${{ secrets.AUTH_MICROSOFT_CLIENT_SECRET }}" >> $GITHUB_ENV
          echo "AUTH_MICROSOFT_ISSUER_URL=${{ secrets.AUTH_MICROSOFT_ISSUER_URL }}" >> $GITHUB_ENV
          echo "AUTH_MICROSOFT_TENANT_ID=${{ secrets.AUTH_MICROSOFT_TENANT_ID }}" >> $GITHUB_ENV
          echo "ENTRA_AUTH_FRONTEND_CLIENT_ID=${{ secrets.NEXT_PUBLIC_ENTRA_CLIENT_ID }}" >> $GITHUB_ENV
          echo "AUTH_MICROSOFT_DEFAULT_ROLE_ID=${{ secrets.DIRECTUS_MEMBER_ROLE_ID }}" >> $GITHUB_ENV
          
          echo "CORS_ALLOW_CREDENTIALS=${{ secrets.CORS_ALLOW_CREDENTIALS }}" >> $GITHUB_ENV

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./directus
          file: ./directus/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.TAG }}
          provenance: false
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Delete Untagged Images
        uses: actions/delete-package-versions@v5
        continue-on-error: true
        with:
          package-name: 'directus'
          package-type: 'container'
          min-versions-to-keep: 2
          delete-only-untagged-versions: 'true'

      - name: Copy Config Files via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "directus/docker-compose.yml"
          target: ${{ env.DEPLOY_PATH }}
          strip_components: 1

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.1
        env:
          GH_REGISTRY: ${{ env.REGISTRY }}
          GH_USERNAME: ${{ github.actor }}
          GH_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
          DEPLOY_PATH: ${{ env.DEPLOY_PATH }}
          TAG: ${{ env.TAG }}
          # Pass env vars
          DIRECTUS_KEY: ${{ env.DIRECTUS_KEY }}
          DIRECTUS_SECRET: ${{ env.DIRECTUS_SECRET }}
          ADMIN_EMAIL: ${{ env.ADMIN_EMAIL }}
          ADMIN_PASSWORD: ${{ env.ADMIN_PASSWORD }}
          PUBLIC_URL: ${{ env.PUBLIC_URL }}
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
          AUTH_MICROSOFT_CLIENT_ID: ${{ env.AUTH_MICROSOFT_CLIENT_ID }}
          AUTH_MICROSOFT_CLIENT_SECRET: ${{ env.AUTH_MICROSOFT_CLIENT_SECRET }}
          AUTH_MICROSOFT_ISSUER_URL: ${{ env.AUTH_MICROSOFT_ISSUER_URL }}
          AUTH_MICROSOFT_TENANT_ID: ${{ env.AUTH_MICROSOFT_TENANT_ID }}
          ENTRA_AUTH_FRONTEND_CLIENT_ID: ${{ env.ENTRA_AUTH_FRONTEND_CLIENT_ID }}
          AUTH_MICROSOFT_DEFAULT_ROLE_ID: ${{ env.AUTH_MICROSOFT_DEFAULT_ROLE_ID }}
          CORS_ORIGIN: ${{ env.CORS_ORIGIN }}
          CORS_ALLOW_CREDENTIALS: ${{ env.CORS_ALLOW_CREDENTIALS }}
          
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: GH_REGISTRY,GH_USERNAME,GH_PASSWORD,DEPLOY_PATH,TAG,DIRECTUS_KEY,DIRECTUS_SECRET,ADMIN_EMAIL,ADMIN_PASSWORD,PUBLIC_URL,POSTGRES_DB,POSTGRES_USER,POSTGRES_PASSWORD,AUTH_MICROSOFT_CLIENT_ID,AUTH_MICROSOFT_CLIENT_SECRET,AUTH_MICROSOFT_ISSUER_URL,AUTH_MICROSOFT_TENANT_ID,ENTRA_AUTH_FRONTEND_CLIENT_ID,AUTH_MICROSOFT_DEFAULT_ROLE_ID,CORS_ORIGIN,CORS_ALLOW_CREDENTIALS
          script: |
            echo $GH_PASSWORD | docker login $GH_REGISTRY -u $GH_USERNAME --password-stdin

            mkdir -p $DEPLOY_PATH
            cd $DEPLOY_PATH

            # Generate .env (Using printf to prevent shell expansion of special characters)
            echo "TAG=$TAG" > .env
            
            # Database
            printf "POSTGRES_USER=%s\n" "$POSTGRES_USER" >> .env
            printf "POSTGRES_PASSWORD=%s\n" "$POSTGRES_PASSWORD" >> .env
            printf "POSTGRES_DB=%s\n" "$POSTGRES_DB" >> .env
            
            # Directus Core
            printf "DIRECTUS_KEY=%s\n" "$DIRECTUS_KEY" >> .env
            printf "DIRECTUS_SECRET=%s\n" "$DIRECTUS_SECRET" >> .env
            echo "EXTENSIONS_AUTO_RELOAD=true" >> .env
            printf "PUBLIC_URL=%s\n" "$PUBLIC_URL" >> .env
            printf "CORS_ORIGIN=%s\n" "$CORS_ORIGIN" >> .env
            printf "CORS_ALLOW_CREDENTIALS=%s\n" "$CORS_ALLOW_CREDENTIALS" >> .env
            
            printf "ADMIN_EMAIL=%s\n" "$ADMIN_EMAIL" >> .env
            printf "ADMIN_PASSWORD=%s\n" "$ADMIN_PASSWORD" >> .env
            
            # Microsoft Auth Configuration
            printf "AUTH_MICROSOFT_CLIENT_ID=%s\n" "$AUTH_MICROSOFT_CLIENT_ID" >> .env
            printf "AUTH_MICROSOFT_CLIENT_SECRET=%s\n" "$AUTH_MICROSOFT_CLIENT_SECRET" >> .env
            echo "AUTH_MICROSOFT_ISSUER_URL=$AUTH_MICROSOFT_ISSUER_URL" >> .env
            
            echo "AUTH_MICROSOFT_ICON=microsoft" >> .env
            echo "AUTH_MICROSOFT_SCOPE=openid profile email" >> .env
            echo "AUTH_PROVIDERS=microsoft" >> .env
            echo "AUTH_MICROSOFT_DRIVER=openid" >> .env
            
            echo "AUTH_MICROSOFT_IDENTIFIER_KEY=email" >> .env
            echo "AUTH_MICROSOFT_ALLOW_PUBLIC_REGISTRATION=true" >> .env
            printf "AUTH_MICROSOFT_DEFAULT_ROLE_ID=%s\n" "$AUTH_MICROSOFT_DEFAULT_ROLE_ID" >> .env
            
            # Custom vars
            echo "AUTH_MICROSOFT_TENANT_ID=$AUTH_MICROSOFT_TENANT_ID" >> .env
            echo "ENTRA_AUTH_FRONTEND_CLIENT_ID=$ENTRA_AUTH_FRONTEND_CLIENT_ID" >> .env
            # echo 'AUTH_ENTRA_FIELDS_MAPPING={"email": "userPrincipalName", "first_name": "givenName", "last_name": "surname"}' >> .env

            # Cookie & Proxy Security (Hardcoded for Prod stability)
            echo "REFRESH_TOKEN_COOKIE_SECURE=true" >> .env
            echo "REFRESH_TOKEN_COOKIE_SAME_SITE=lax" >> .env
            echo "TRUSTED_PROXIES=10.0.0.0/8,172.16.0.0/12,192.168.0.0/16" >> .env

            # Restart
            docker compose pull
            docker compose up -d --force-recreate --remove-orphans

            echo "Waiting for container to be healthy..."
            CONTAINER_NAME="directus"
            for i in {1..20}; do
              STATUS=$(docker inspect --format='{{.State.Health.Status}}' $CONTAINER_NAME 2>/dev/null || echo "starting")
              echo "Current status: $STATUS"
              if [[ "$STATUS" == "healthy" ]]; then
                echo "✅ Container is healthy!"
                exit 0
              fi
              if [[ "$STATUS" == "unhealthy" ]]; then
                echo "❌ Container is UNHEALTHY!"
                docker logs $CONTAINER_NAME | tail -n 50
                exit 1
              fi
              sleep 10
            done
            echo "⏳ Health check TIMEOUT! (Or no HEALTHCHECK defined)"
            exit 0